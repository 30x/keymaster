error_log /dev/stderr;
worker_processes auto;

events {
  worker_connections 256;
}

http {
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 5;

  server {
    {{ range $bundle := .Bundles }}
      {{ range .VirtualHosts }}
        listen {{ . }};
      {{- end }}

      {{ range .Pipes }}
        location {{ $bundle.Basepath }}{{ .Path }} {
          set $goz_pipe '{{ .Name }}';
          access_by_lua_file '../lua/gozerian-request.lua';
          header_filter_by_lua_file '../lua/gozerian-header-filter.lua';
          body_filter_by_lua_file '../lua/gozerian-body-filter.lua';
          proxy_pass {{ $bundle.Target }};
        }
      {{ end }}
    {{- end }}
  }
}
